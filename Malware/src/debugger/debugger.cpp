#include "../stdafx/stdafx.h"

#include <Windows.h>
#include <winternl.h>

#include "debugger.h"

bool isDbg() {
#ifndef _DEBUG
	if (IsDebuggerPresent()) return true;

	BOOL test;
	CheckRemoteDebuggerPresent(GetCurrentProcess(), &test); // fonction fournie par windows
	if (test) return true;

	PEB *ppeb;
	__asm {
		mov eax, fs:[0x30] ; adresse connue, souvent detecté par les antivirus comme un comportement malveillant
		mov ppeb, eax ; on peut utiliser des variales de C dans la partie assembleur
	}
	if (ppeb->BeingDebugged) return true;

	char *p = (char*) ppeb;
	if (p[104] & 0x70) { // non documenté par windows, mais expérimentalement, permet de savoir si on est debuggé ou non
		return true;
	}
#endif
	return false;
}