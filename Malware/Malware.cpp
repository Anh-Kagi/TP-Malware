#include "stdafx.h"

#include <iostream>
#include <string>
#include <sstream>

#include <Windows.h>
#include <winternl.h>

using namespace std;

char* getArg(_TCHAR* arg) {
	int argLength = wcslen(arg);
	int retLength = WideCharToMultiByte(CP_ACP, 0, arg, argLength, NULL, 0, NULL, NULL); // get required length
	char* ret = new char[retLength + 1];
	WideCharToMultiByte(CP_ACP, 0, arg, argLength, ret, retLength, NULL, NULL);

	ret[retLength] = '\0';

	return ret;
}

bool isDbg() {
	if (IsDebuggerPresent()) return true;

	BOOL test;
	CheckRemoteDebuggerPresent(GetCurrentProcess(), &test); // fonction fournie par windows
	if (test) return true;

	PEB *ppeb;
	__asm {
		mov eax, fs:[0x30] ; adresse connue, souvent detecté par les antivirus comme un comportement malveillant
		mov ppeb, eax ; on peut utiliser des variales de C dans la partie assembleur
	}
	if (ppeb->BeingDebugged) return true;

	char *p = (char*) ppeb;
	if (p[104] & 0x70) { // non documenté par windows, mais expérimentalement, permet de savoir si on est debuggé ou non
		return true;
	}

	return false;
}

bool isHex(const char* str) {
	for (int i = 0; str[i] != '\0'; i++)
		if (!(('a' <= str[i] && str[i] <= 'f') || ('0' <= str[i] && str[i] <= '9')))
			return false;
	return true;
}

int _tmain(int argc, _TCHAR* argv[])
{
	for (int i=0; i<argc; i++) {
		char* arg = getArg(argv[i]);
		cout << "argv[" << i << "]=" << arg << endl;
		delete[] arg;
	}

	if (isDbg()) {
		cerr << "arrête de me débugger stp :(" << endl;
		return -1;
	}

	char* key = "4num3r1c01v";
	if (argc < 2) {
		cerr << "c'est pas bon" << endl;
		return -2;
	}

	char* arg = getArg(argv[1]);
	if (!isHex(arg)) {
		cerr << "faudrait peut-etre savoir ecrire par contre..." << endl;
		// pas en hexa
		return -3;
	}
	
	int input;
	istringstream iss(arg);
	iss >> hex >> input;
	cout << "input: " << input << endl;
	cout << "key: " << key << " argv[1]: " << arg << endl;
	if (!strcmp(key, arg)) {
		cout << "gg" << endl;
	} else {
		cerr << "c'est toujouts pas bon, tri agun" << endl;
	}
	delete[] arg;

	return 0;
}

